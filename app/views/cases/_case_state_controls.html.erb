
<% if policy(@case).resolve? %>
  <% if @case.resolvable? %>
    <%= link_to 'Resolve this case',
                resolve_case_path(@case.id),
                class: 'btn btn-secondary ml-2 btn-sm',
                method: :post,
                role: 'button',
                title: 'Resolve this support case if it has been completed or is no longer relevant',
                data: {
                    confirm: 'Are you sure you want to resolve this support case?'
                }
    %>
  <% elsif @case.open? %>
    <p class="small" id="unresolvable-reason"><%= @case.unresolvable_reason %></p>
  <% end %>
<% end %>

<% if policy(@case).reopen? && @case.can_reopen? %>
  <%
    modal_id = 'reopen_case_modal'
    modal_label_id = 'reopen_case_modal_label'
  %>
  <%= button_tag 'Reopen this case',
                 {
                    class: 'btn btn-danger ml-2 btn-sm',
                    method: :post,
                    role: 'button',
                    title: 'Reopen this support case if the original issue has not been resolved.',
                    data: {
                      toggle: 'modal',
                      target: "##{modal_id}",
                    }
                 }
  %>

  <div
    class="modal fade"
    id="<%= modal_id %>"
    tabindex="-1"
    role="dialog"
    aria-labelledby="<%= modal_label_id %>"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered" role="document">
      <%= form_tag reopen_case_path(@case), method: :post do |f| %>
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="<%= modal_label_id %>">
              Reopen case
            </h5>
            <button class="close" data-dismiss="modal">Ã—</button>
          </div>
          <div class="modal-body">
            <p>Please explain your reasons for wanting to reopen this case:</p>
            <textarea
              class="form-control"
              name="comment"
              rows="3"

               ></textarea>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-primary" data-dismiss="modal">
              Cancel
            </button>


            <%= submit_tag 'Reopen',
                        class: 'btn btn-outline-danger',
                        id: 'confirm-reopen-button',
                        role: 'button'
            %>

          </div>
        </div>
      <% end %>
    </div>
  </div>

<% end %>

<% if policy(@case).close? && @case.can_close? %>
  <%= form_tag({controller: 'cases', action: 'close'},
               method: :post,
               class: 'form-inline mt-2',
               id: 'case-close-form'
      ) do %>
      <% if @case.cr_charge_applies? %>
        <p class="small">
          Charge below should include <%= pluralize(@case.change_request.credit_charge, 'credit') %> from attached CR
        </p>
      <% end %>
      <div class="form-group">
        <div class="input-group">
          <%= number_field :credit_charge,
                           :amount,
                           class: 'form-control',
                           min: @case.minimum_credit_charge,
                           required: 'required',
                           value: @case.minimum_credit_charge
        %>
        <div class="input-group-append">
          <%= submit_tag 'Set charge and close case',
                         class: 'form-control btn btn-primary btn-sm',
                         data: {
                             confirm: 'Are you sure you want to close this support case?'
                         }
          %>
        </div>
      </div>
    </div>
  <% end %>
<% end %>
